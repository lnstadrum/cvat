metadata:
  name: pytorch-wongkinyiu-yolov7-pose
  namespace: cvat
  annotations:
    name: YOLO v7 Pose
    type: detector
    framework: pytorch
    spec: |
      [
        {
          "name": "Player",
          "type": "skeleton",
          "svg": "<line x1=\"48.87604904174805\" y1=\"9.485294342041016\" x2=\"49.21218490600586\" y2=\"7.636554718017578\" data-type=\"edge\" data-node-from=\"1\" data-node-to=\"2\" stroke=\"black\" stroke-width=\"0.5\"></line>\n<line x1=\"60.80882263183594\" y1=\"19.90546226501465\" x2=\"48.87604904174805\" y2=\"9.485294342041016\" data-type=\"edge\" data-node-from=\"3\" data-node-to=\"1\" stroke=\"black\" stroke-width=\"0.5\"></line>\n<line x1=\"63.83403396606445\" y1=\"34.023109436035156\" x2=\"60.80882263183594\" y2=\"19.90546226501465\" data-type=\"edge\" data-node-from=\"5\" data-node-to=\"3\" stroke=\"black\" stroke-width=\"0.5\"></line>\n<line x1=\"66.85924530029297\" y1=\"47.132354736328125\" x2=\"63.83403396606445\" y2=\"34.023109436035156\" data-type=\"edge\" data-node-from=\"7\" data-node-to=\"5\" stroke=\"black\" stroke-width=\"0.5\"></line>\n<line x1=\"58.119747161865234\" y1=\"71.16596984863281\" x2=\"57.78361511230469\" y2=\"87.97268676757812\" data-type=\"edge\" data-node-from=\"11\" data-node-to=\"13\" stroke=\"black\" stroke-width=\"0.5\"></line>\n<line x1=\"57.11134338378906\" y1=\"49.65336227416992\" x2=\"58.119747161865234\" y2=\"71.16596984863281\" data-type=\"edge\" data-node-from=\"9\" data-node-to=\"11\" stroke=\"black\" stroke-width=\"0.5\"></line>\n<line x1=\"48.87604904174805\" y1=\"9.485294342041016\" x2=\"57.11134338378906\" y2=\"49.65336227416992\" data-type=\"edge\" data-node-from=\"1\" data-node-to=\"9\" stroke=\"black\" stroke-width=\"0.5\"></line>\n<line x1=\"44.00210189819336\" y1=\"50.157562255859375\" x2=\"48.87604904174805\" y2=\"9.485294342041016\" data-type=\"edge\" data-node-from=\"10\" data-node-to=\"1\" stroke=\"black\" stroke-width=\"0.5\"></line>\n<line x1=\"44.338233947753906\" y1=\"70.6617660522461\" x2=\"44.00210189819336\" y2=\"50.157562255859375\" data-type=\"edge\" data-node-from=\"12\" data-node-to=\"10\" stroke=\"black\" stroke-width=\"0.5\"></line>\n<line x1=\"46.186973571777344\" y1=\"92.51050567626953\" x2=\"44.338233947753906\" y2=\"70.6617660522461\" data-type=\"edge\" data-node-from=\"14\" data-node-to=\"12\" stroke=\"black\" stroke-width=\"0.5\"></line>\n<line x1=\"35.93487548828125\" y1=\"34.35924530029297\" x2=\"33.918067932128906\" y2=\"47.46848678588867\" data-type=\"edge\" data-node-from=\"6\" data-node-to=\"8\" stroke=\"black\" stroke-width=\"0.5\"></line>\n<line x1=\"37.78361511230469\" y1=\"20.409664154052734\" x2=\"35.93487548828125\" y2=\"34.35924530029297\" data-type=\"edge\" data-node-from=\"4\" data-node-to=\"6\" stroke=\"black\" stroke-width=\"0.5\"></line>\n<line x1=\"48.87604904174805\" y1=\"9.485294342041016\" x2=\"37.78361511230469\" y2=\"20.409664154052734\" data-type=\"edge\" data-node-from=\"1\" data-node-to=\"4\" stroke=\"black\" stroke-width=\"0.5\"></line>\n<circle r=\"0.75\" cx=\"48.87604904174805\" cy=\"9.485294342041016\" data-type=\"element node\" data-element-id=\"1\" data-node-id=\"1\" stroke=\"black\" fill=\"#b3b3b3\" stroke-width=\"0.1\" data-label-name=\"neck\"></circle>\n<circle r=\"0.75\" cx=\"49.21218490600586\" cy=\"7.636554718017578\" data-type=\"element node\" data-element-id=\"2\" data-node-id=\"2\" stroke=\"black\" fill=\"#b3b3b3\" stroke-width=\"0.1\" data-label-name=\"head\"></circle>\n<circle r=\"0.75\" cx=\"60.80882263183594\" cy=\"19.90546226501465\" data-type=\"element node\" data-element-id=\"3\" data-node-id=\"3\" stroke=\"black\" fill=\"#b3b3b3\" stroke-width=\"0.1\" data-label-name=\"L shoulder\"></circle>\n<circle r=\"0.75\" cx=\"37.78361511230469\" cy=\"20.409664154052734\" data-type=\"element node\" data-element-id=\"4\" data-node-id=\"4\" stroke=\"black\" fill=\"#b3b3b3\" stroke-width=\"0.1\" data-label-name=\"R shoulder\"></circle>\n<circle r=\"0.75\" cx=\"63.83403396606445\" cy=\"34.023109436035156\" data-type=\"element node\" data-element-id=\"5\" data-node-id=\"5\" stroke=\"black\" fill=\"#b3b3b3\" stroke-width=\"0.1\" data-label-name=\"L elbow\"></circle>\n<circle r=\"0.75\" cx=\"35.93487548828125\" cy=\"34.35924530029297\" data-type=\"element node\" data-element-id=\"6\" data-node-id=\"6\" stroke=\"black\" fill=\"#b3b3b3\" stroke-width=\"0.1\" data-label-name=\"R elbow\"></circle>\n<circle r=\"0.75\" cx=\"66.85924530029297\" cy=\"47.132354736328125\" data-type=\"element node\" data-element-id=\"7\" data-node-id=\"7\" stroke=\"black\" fill=\"#b3b3b3\" stroke-width=\"0.1\" data-label-name=\"L wrist\"></circle>\n<circle r=\"0.75\" cx=\"33.918067932128906\" cy=\"47.46848678588867\" data-type=\"element node\" data-element-id=\"8\" data-node-id=\"8\" stroke=\"black\" fill=\"#b3b3b3\" stroke-width=\"0.1\" data-label-name=\"R wrist\"></circle>\n<circle r=\"0.75\" cx=\"57.11134338378906\" cy=\"49.65336227416992\" data-type=\"element node\" data-element-id=\"9\" data-node-id=\"9\" stroke=\"black\" fill=\"#b3b3b3\" stroke-width=\"0.1\" data-label-name=\"L hip\"></circle>\n<circle r=\"0.75\" cx=\"44.00210189819336\" cy=\"50.157562255859375\" data-type=\"element node\" data-element-id=\"10\" data-node-id=\"10\" stroke=\"black\" fill=\"#b3b3b3\" stroke-width=\"0.1\" data-label-name=\"R hip\"></circle>\n<circle r=\"0.75\" cx=\"58.119747161865234\" cy=\"71.16596984863281\" data-type=\"element node\" data-element-id=\"11\" data-node-id=\"11\" stroke=\"black\" fill=\"#b3b3b3\" stroke-width=\"0.1\" data-label-name=\"L knee\"></circle>\n<circle r=\"0.75\" cx=\"44.338233947753906\" cy=\"70.6617660522461\" data-type=\"element node\" data-element-id=\"12\" data-node-id=\"12\" stroke=\"black\" fill=\"#b3b3b3\" stroke-width=\"0.1\" data-label-name=\"R knee\"></circle>\n<circle r=\"0.75\" cx=\"57.78361511230469\" cy=\"87.97268676757812\" data-type=\"element node\" data-element-id=\"13\" data-node-id=\"13\" stroke=\"black\" fill=\"#b3b3b3\" stroke-width=\"0.1\" data-label-name=\"L ankle\"></circle>\n<circle r=\"0.75\" cx=\"46.186973571777344\" cy=\"92.51050567626953\" data-type=\"element node\" data-element-id=\"14\" data-node-id=\"14\" stroke=\"black\" fill=\"#b3b3b3\" stroke-width=\"0.1\" data-label-name=\"R ankle\"></circle>",
          "sublabels": [
              { "id": 0, "name": "neck", "type": "points" },
              { "id": 1, "name": "head", "type": "points" },
              { "id": 2, "name": "L shoulder", "type": "points" },
              { "id": 3, "name": "R shoulder", "type": "points" },
              { "id": 4, "name": "L elbow", "type": "points" },
              { "id": 5, "name": "R elbow", "type": "points" },
              { "id": 6, "name": "L wrist", "type": "points" },
              { "id": 7, "name": "R wrist", "type": "points" },
              { "id": 8, "name": "L hip", "type": "points" },
              { "id": 9, "name": "R hip", "type": "points" },
              { "id": 10, "name": "L knee", "type": "points" },
              { "id": 11, "name": "R knee", "type": "points" },
              { "id": 12, "name": "L ankle", "type": "points" },
              { "id": 13, "name": "R ankle", "type": "points" }
          ]
        }
      ]
spec:
  description: YOLO v7 pose via torch
  runtime: 'python:3.8'
  handler: main:handler
  eventTimeout: 30s
  build:
    image: cvat.torch.wongkinyiu.yolov7pose
    baseImage: ubuntu:22.04

    directives:
      preCopy:
        - kind: USER
          value: root
        - kind: RUN
          value: apt update && apt install -y libgl1-mesa-glx libglib2.0-0 python3-pip git
        - kind: WORKDIR
          value: /opt/nuclio
        - kind: RUN
          value: git clone https://github.com/WongKinYiu/yolov7.git
        - kind: RUN
          value: pip install -r yolov7/requirements.txt
        - kind: ADD
          value: https://github.com/WongKinYiu/yolov7/releases/download/v0.1/yolov7-w6-pose.pt .
        - kind: ENV
          value: PYTHONPATH=/opt/nuclio/yolov7
        - kind: RUN
          value: ln -s /usr/bin/python3 /usr/bin/python

  triggers:
    myHttpTrigger:
      maxWorkers: 2
      kind: 'http'
      workerAvailabilityTimeoutMilliseconds: 10000
      attributes:
        maxRequestBodySize: 33554432 # 32MB

  platform:
    attributes:
      restartPolicy:
        name: always
        maximumRetryCount: 3
      mountMode: volume
